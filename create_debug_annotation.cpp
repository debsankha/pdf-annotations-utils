#include <iostream>
#include <format>
#include <iostream>
#include <string>
#include <string_view>
#include <QColor>



#include <poppler-qt5.h>
#include <QFont>

using namespace Poppler;
using namespace std;

bool annotations_eq(Annotation* annot, Annotation* annot2) {
    return (annot->creationDate() == annot2->creationDate())
    & (annot->boundary() == annot2->boundary());
}

// look at okular src: generators/poppler/annots.cpp::265

int main() {
    // we will add stuff from file1 to file2
    QString file1 = "/Users/debsankha.manik/private_projects/poppler-qt5/small_plain.pdf";
    QString file2 = "/Users/debsankha.manik/private_projects/poppler-qt5/small_manual.pdf";
    Document* doc = Document::load(file1);

    // now read the pages
    Page* page = doc->page(0);

    // sanity check: Geom
    auto gannot = new GeomAnnotation();
    gannot->setGeomType(GeomAnnotation::GeomType::InscribedCircle);
    gannot->setBoundary({0.1, 0.1, 0.2, 0.2});
    gannot->setGeomInnerColor(QColorConstants::DarkGreen);
//    gannot->setContents("whfbciluqefbncl/an");
//    gannot->style().setWidth(10.0);
//    gannot->style().setColor(QColorConstants::DarkGreen);
//    gannot->style().setOpacity(1.0);

    page->addAnnotation(gannot);
    delete gannot;

    //creating a new InkAnnotation does not work
    auto newannot = new InkAnnotation();

    newannot->setFlags(0);
    newannot->setBoundary({0.5366459510357815, 0.3302867867867868, 0.35134651600753297, 0.02092342342342346});

    auto s = newannot->style();
    s.setColor(QColorConstants::DarkRed);
    s.setLineStyle(Annotation::LineStyle::Solid);

    s.setWidth(5);
    s.setOpacity(0.5);
    s.setLineEffect(Annotation::LineEffect::NoEffect);

    QLinkedList<QPointF> path{
            {0.547,0.342}, {0.548,0.343}, {0.548,0.342}, {0.549,0.342}, {0.550,0.342}, {0.551,0.342}, {0.551,0.342}, {0.552,0.342}, {0.553,0.342}, {0.553,0.342}, {0.554,0.342}, {0.555,0.342}, {0.556,0.342}, {0.556,0.342}, {0.557,0.342}, {0.558,0.342}, {0.558,0.342}, {0.559,0.342}, {0.560,0.342}, {0.561,0.342}, {0.561,0.342}, {0.562,0.342}, {0.563,0.342}, {0.563,0.342}, {0.564,0.342}, {0.565,0.342}, {0.566,0.342}, {0.566,0.342}, {0.567,0.342}, {0.568,0.342}, {0.568,0.342}, {0.569,0.342}, {0.570,0.342}, {0.571,0.342}, {0.571,0.342}, {0.572,0.342}, {0.573,0.342}, {0.573,0.342}, {0.574,0.342}, {0.575,0.342}, {0.575,0.342}, {0.576,0.342}, {0.577,0.342}, {0.578,0.342}, {0.578,0.342}, {0.579,0.342}, {0.580,0.342}, {0.580,0.342}, {0.580,0.341}, {0.581,0.341}, {0.582,0.341}, {0.583,0.341}, {0.583,0.342}, {0.584,0.341}, {0.585,0.342}, {0.586,0.342}, {0.586,0.341}, {0.587,0.341}, {0.588,0.341}, {0.588,0.341}, {0.589,0.341}, {0.590,0.341}, {0.590,0.341}, {0.591,0.341}, {0.592,0.341}, {0.593,0.341}, {0.593,0.341}, {0.594,0.341}, {0.595,0.341}, {0.595,0.341}, {0.596,0.341}, {0.597,0.341}, {0.598,0.341}, {0.598,0.341}, {0.599,0.341}, {0.600,0.341}, {0.600,0.341}, {0.601,0.341}, {0.602,0.341}, {0.603,0.341}, {0.603,0.341}, {0.604,0.341}, {0.605,0.341}, {0.605,0.341}, {0.605,0.341}, {0.606,0.341}, {0.607,0.341}, {0.608,0.341}, {0.608,0.341}, {0.609,0.341}, {0.610,0.341}, {0.610,0.341}, {0.611,0.341}, {0.612,0.341}, {0.613,0.341}, {0.613,0.341}, {0.614,0.341}, {0.615,0.341}, {0.615,0.341}, {0.616,0.341}, {0.617,0.341}, {0.618,0.341}, {0.618,0.341}, {0.619,0.341}, {0.620,0.341}, {0.620,0.341}, {0.621,0.341}, {0.622,0.341}, {0.623,0.341}, {0.623,0.341}, {0.624,0.341}, {0.625,0.341}, {0.625,0.341}, {0.626,0.341}, {0.627,0.341}, {0.627,0.341}, {0.628,0.341}, {0.629,0.341}, {0.630,0.341}, {0.630,0.341}, {0.631,0.341}, {0.632,0.341}, {0.632,0.341}, {0.633,0.341}, {0.634,0.341}, {0.635,0.341}, {0.635,0.341}, {0.636,0.341}, {0.637,0.341}, {0.637,0.341}, {0.638,0.341}, {0.639,0.341}, {0.640,0.341}, {0.640,0.341}, {0.641,0.341}, {0.642,0.341}, {0.642,0.341}, {0.643,0.341}, {0.644,0.341}, {0.645,0.341}, {0.645,0.341}, {0.645,0.341}, {0.646,0.341}, {0.647,0.341}, {0.647,0.341}, {0.648,0.341}, {0.649,0.341}, {0.650,0.341}, {0.650,0.341}, {0.651,0.341}, {0.652,0.341}, {0.653,0.341}, {0.654,0.341}, {0.655,0.341}, {0.655,0.341}, {0.657,0.341}, {0.657,0.341}, {0.658,0.341}, {0.659,0.341}, {0.660,0.340}, {0.660,0.341}, {0.660,0.341}, {0.661,0.341}, {0.662,0.341}, {0.663,0.341}, {0.664,0.341}, {0.665,0.341}, {0.665,0.341}, {0.666,0.341}, {0.667,0.341}, {0.667,0.341}, {0.668,0.341}, {0.669,0.341}, {0.670,0.341}, {0.671,0.341}, {0.672,0.341}, {0.672,0.341}, {0.673,0.341}, {0.674,0.341}, {0.675,0.341}, {0.675,0.341}, {0.676,0.341}, {0.677,0.341}, {0.677,0.341}, {0.678,0.341}, {0.679,0.341}, {0.679,0.341}, {0.680,0.341}, {0.681,0.341}, {0.682,0.341}, {0.682,0.341}, {0.683,0.341}, {0.684,0.341}, {0.685,0.341}, {0.687,0.341}, {0.687,0.341}, {0.688,0.341}, {0.689,0.341}, {0.689,0.341}, {0.691,0.341}, {0.692,0.341}, {0.692,0.341}, {0.693,0.341}, {0.694,0.341}, {0.694,0.341}, {0.695,0.341}, {0.697,0.341}, {0.698,0.341}, {0.699,0.341}, {0.699,0.341}, {0.700,0.341}, {0.701,0.341}, {0.702,0.341}, {0.702,0.341}, {0.703,0.341}, {0.704,0.341}, {0.704,0.341}, {0.705,0.341}, {0.706,0.341}, {0.707,0.341}, {0.708,0.341}, {0.709,0.341}, {0.709,0.341}, {0.710,0.341}, {0.711,0.341}, {0.712,0.341}, {0.712,0.341}, {0.713,0.341}, {0.714,0.341}, {0.714,0.341}, {0.715,0.341}, {0.716,0.341}, {0.717,0.341}, {0.717,0.341}, {0.718,0.341}, {0.719,0.341}, {0.719,0.341}, {0.720,0.341}, {0.721,0.341}, {0.722,0.341}, {0.722,0.341}, {0.723,0.341}, {0.724,0.341}, {0.724,0.341}, {0.726,0.341}, {0.726,0.341}, {0.727,0.341}, {0.728,0.341}, {0.729,0.341}, {0.729,0.341}, {0.730,0.341}, {0.731,0.341}, {0.731,0.341}, {0.732,0.341}, {0.733,0.341}, {0.734,0.341}, {0.734,0.341}, {0.735,0.341}, {0.736,0.341}, {0.737,0.341}, {0.739,0.341}, {0.739,0.341}, {0.740,0.341}, {0.741,0.341}, {0.741,0.341}, {0.742,0.341}, {0.743,0.340}, {0.744,0.340}, {0.744,0.340}, {0.746,0.340}, {0.747,0.340}, {0.748,0.340}, {0.749,0.340}, {0.749,0.340}, {0.750,0.340}, {0.751,0.340}, {0.751,0.340}, {0.752,0.340}, {0.753,0.340}, {0.754,0.340}, {0.754,0.340}, {0.756,0.340}, {0.756,0.340}, {0.757,0.340}, {0.758,0.340}, {0.759,0.340}, {0.760,0.340}, {0.761,0.340}, {0.762,0.340}, {0.764,0.340}, {0.765,0.340}, {0.766,0.340}, {0.766,0.340}, {0.768,0.340}, {0.769,0.340}, {0.769,0.340}, {0.770,0.340}, {0.771,0.340}, {0.771,0.340}, {0.772,0.340}, {0.773,0.340}, {0.774,0.339}, {0.774,0.340}, {0.775,0.340}, {0.775,0.339}, {0.776,0.339}, {0.777,0.339}, {0.778,0.339}, {0.778,0.339}, {0.779,0.339}, {0.780,0.339}, {0.781,0.339}, {0.781,0.339}, {0.783,0.339}, {0.783,0.339}, {0.784,0.339}, {0.786,0.339}, {0.786,0.339}, {0.788,0.339}, {0.788,0.339}, {0.789,0.339}, {0.790,0.339}, {0.791,0.339}, {0.791,0.339}, {0.792,0.339}, {0.793,0.339}, {0.794,0.339}, {0.795,0.339}, {0.796,0.339}, {0.796,0.339}, {0.797,0.339}, {0.798,0.339}, {0.798,0.339}, {0.799,0.339}, {0.800,0.339}, {0.801,0.339}, {0.802,0.339}, {0.803,0.339}, {0.803,0.339}, {0.804,0.339}, {0.806,0.339}, {0.806,0.339}, {0.807,0.339}, {0.808,0.339}, {0.809,0.339}, {0.810,0.339}, {0.811,0.339}, {0.811,0.339}, {0.812,0.339}, {0.813,0.340}, {0.813,0.340}, {0.814,0.340}, {0.815,0.340}, {0.816,0.340}, {0.816,0.340}, {0.817,0.340}, {0.818,0.340}, {0.818,0.340}, {0.818,0.340}, {0.819,0.340}, {0.820,0.340}, {0.821,0.340}, {0.821,0.340}, {0.822,0.340}, {0.823,0.340}, {0.823,0.340}, {0.825,0.340}, {0.825,0.340}, {0.826,0.340}, {0.827,0.340}, {0.828,0.340}, {0.828,0.340}, {0.829,0.340}, {0.830,0.340}, {0.830,0.340}, {0.830,0.341}, {0.831,0.341}, {0.832,0.341}, {0.833,0.341}, {0.833,0.341}, {0.835,0.341}, {0.835,0.341}, {0.836,0.341}, {0.837,0.341}, {0.838,0.341}, {0.838,0.341}, {0.839,0.341}, {0.840,0.341}, {0.840,0.341}, {0.841,0.341}, {0.842,0.341}, {0.843,0.341}, {0.843,0.341}, {0.844,0.340}, {0.845,0.341}, {0.845,0.341}, {0.846,0.341}, {0.847,0.341}, {0.848,0.341}, {0.848,0.341}, {0.849,0.341}, {0.850,0.341}, {0.850,0.341}, {0.851,0.341}, {0.852,0.341}, {0.853,0.341}, {0.853,0.341}, {0.854,0.341}, {0.855,0.341}, {0.855,0.341}, {0.856,0.341}, {0.857,0.341}, {0.858,0.341}, {0.858,0.341}, {0.859,0.341}, {0.860,0.341}, {0.860,0.341}, {0.861,0.341}, {0.862,0.341}, {0.863,0.341}, {0.863,0.341}, {0.864,0.341}, {0.865,0.341}, {0.865,0.341}, {0.866,0.341}, {0.867,0.341}, {0.868,0.341}, {0.868,0.341}, {0.869,0.341}, {0.870,0.341}, {0.870,0.341}, {0.871,0.341}, {0.872,0.341}, {0.873,0.341}, {0.873,0.341}, {0.874,0.341}, {0.874,0.342}, {0.875,0.342}, {0.875,0.342}, {0.876,0.342}, {0.877,0.342}, {0.877,0.342}, {0.877,0.342}
    };
    QList<QLinkedList<QPointF>> inkPaths {{path}};

    newannot->setInkPaths(inkPaths);
    newannot->setStyle(s);

    newannot->setBoundary({0.5366459510357815, 0.3302867867867868, 0.35134651600753297, 0.02092342342342346});
    page->addAnnotation(newannot);
    delete newannot;

    // create line
    //auto l = new LineAnnotation(LineAnnotation::LineType::StraightLine);
    auto l = new LineAnnotation(LineAnnotation::LineType::Polyline);
    l->setBoundary({0.1, 0.1, 0.8, 0.8});
    l->setLinePoints({{0.14, 0.35}, {0.4,0.65}, {0.8, 0.95}});
    //l->setLinePoints({{0.14, 0.35}, {0.8, 0.95}});
    //l->setLineClosed(true);

    Annotation::Style t;
    //s.setOpacity(1.0);
    t.setColor(QColorConstants::DarkGreen);
    l->setStyle(t);

    //l->setLineInnerColor(QColorConstants::DarkRed);
    // l->setLineIntent(LineAnnotation::LineIntent::Dimension);
    l->setLineStartStyle(LineAnnotation::TermStyle::OpenArrow);
    l->setLineEndStyle(LineAnnotation::TermStyle::OpenArrow);


    page->addAnnotation(l);

    // write pdf
    PDFConverter *pdfConv = doc->pdfConverter();
    pdfConv->setOutputFileName(file2);
    pdfConv->setPDFOptions(pdfConv->pdfOptions()|PDFConverter::WithChanges);
    bool success = pdfConv->convert();
    delete pdfConv;

    return 0;
}